{% extends 'layout.html' %}
{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Get CSRF token from cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        $('#predict-form').submit(function (event) {
            event.preventDefault();  // Prevent form submission

            var formData = new FormData();
            formData.append('csv_file', $('#csv-file')[0].files[0]);

            // Show loading message
            $('#result').text('Model is training. Please wait it takes about 2 minutes or less');

            // Send AJAX POST request to the '/predict2' endpoint
            $.ajax({
                url: '/predict',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', csrftoken);  // Add CSRF token to request headers
                },
                success: function (response) {
                    // Update result with the received response
                    $('#result-table tbody').empty();
                    $('#result').empty();

                    // Iterate over the data and create table rows
                    $.each(response.data.date, function (index, value) {
                        var newRow = $('<tr>');
                        newRow.append($('<td>').text(value));
                        newRow.append($('<td>').text('Rs.'+ response.data.close_price[index]));
                        $('#result-table tbody').append(newRow);
                    });
                },
                error: function (xhr, status, error) {
                    // Handle error if necessary
                    console.log(error);
                }
            });
        });
    });
</script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<section class="breadcrumbs">
    <div class="container">

        <div class="d-flex justify-content-between align-items-center">
            <h2>Prediction Result</h2>
        </div>

    </div>
</section><!-- End Breadcrumbs Section -->
<section class="inner-page">
    <div class="container">
        <div class="section-title" data-aos="fade-up">
            <h2>Result</h2>
        </div>
        <form id="predict-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
           
            <input type="file" id="csv-file" name="csv_file">
            <input class="btn btn-primary px-4" type="submit" value="Predict">
        </form>

        <p class="text-danger" id="result"></p>

        <table class="table table-striped" id="result-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Close Price</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>


{% endblock %}